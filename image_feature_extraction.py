import cv2
from djitellopy import Tello
import time

# ==========================================
# 1. 드론 연결 및 초기 설정
# ==========================================
print("드론에 연결 중입니다...")
me = Tello()
me.connect()

# 배터리 잔량 확인 (개발할 때는 배터리 체크가 필수입니다)
print(f"현재 배터리 잔량: {me.get_battery()}%")

# 카메라 스트림 켜기
me.streamon()

# ==========================================
# 2. ORB 알고리즘 설정 (특징점 추출기)
# ==========================================
# ORB(Oriented FAST and Rotated BRIEF)는 빠르고 효율적인 특징점 추출 알고리즘입니다.
# nfeatures=1000: 한 화면에서 최대 1000개의 점을 찾겠다는 의미입니다.
# 너무 적으면 지도가 안 그려지고, 너무 많으면 렉이 걸립니다.
orb = cv2.ORB_create(nfeatures=1000)

print("영상 스트리밍 시작! (종료하려면 화면을 클릭하고 'q'를 누르세요)")

while True:
    # ==========================================
    # 3. 이미지 가져오기 & 전처리
    # ==========================================
    # 드론으로부터 현재 프레임(이미지)을 한 장 가져옵니다.
    img = me.get_frame_read().frame

    # 이미지 크기를 절반 정도로 줄이면 처리 속도(FPS)가 빨라집니다.
    # 필요하다면 아래 주석을 해제하세요. (360x240 해상도)
    # img = cv2.resize(img, (360, 240))

    # ==========================================
    # 4. 특징점 검출 (Detection) - 핵심 파트
    # ==========================================
    # orb.detectAndCompute(이미지, 마스크)
    # - kp (Keypoints): 찾은 점들의 위치 정보 (x, y 좌표 등)
    # - des (Descriptors): 각 점들의 고유한 지문 정보 (나중에 점끼리 매칭할 때 사용)
    kp, des = orb.detectAndCompute(img, None)

    # ==========================================
    # 5. 시각화 (Visualization)
    # ==========================================
    # 원본 이미지(img) 위에 찾은 특징점(kp)을 초록색 동그라미로 그립니다.
    # color=(0, 255, 0): 초록색 (Blue, Green, Red 순서)
    img_kp = cv2.drawKeypoints(img, kp, None, color=(0, 255, 0), flags=0)

    # 화면에 출력
    cv2.imshow("Tello Feature Extraction", img_kp)

    # ==========================================
    # 6. 종료 조건
    # ==========================================
    # 키보드의 'q'를 누르면 루프를 빠져나옵니다.
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

# ==========================================
# 7. 정리 (Cleanup)
# ==========================================
me.streamoff()          # 스트림 끄기
cv2.destroyAllWindows() # 윈도우 창 닫기
print("연결을 종료합니다.")